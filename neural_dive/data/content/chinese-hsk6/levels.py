"""
Level layouts and entity positions for Chinese HSK 6 content.
Defines the structure and predefined positions for each floor.

Legend:
  # = wall
  . = floor
  @ = player start
  < = stairs up
  > = stairs down
  T = terminal location
  Chinese characters = NPC spawn points (must match NPC char in npcs.json)
"""

# Floor 1: Vocabulary and Idioms Fundamentals
FLOOR_1_LAYOUT = """
##################################################
#.<..............................................#
#.@..............................................#
#................................................#
#................................................#
#................................................#
#................................................#
#..................T.............................#
#................................................#
#..........文.....................................#
#................................................#
#................................................#
#.....思..........................................#
#................................................#
#####......#########......########################
#...#......#.......#......#.........#............#
#...#......#.......#......#.........#............#
#...#......#.......#......#.........#............#
#...#......#########......#.........#............#
#...#............................................#
#...#............................................#
#...#.................................词..........#
#...#............................................#
#...##########################################...#
#................................................#
#...............成................................#
#.........................................>......#
##################################################
"""

# Floor 2: Culture, Grammar, and Measure Words
FLOOR_2_LAYOUT = """
##################################################
#................................................#
#..<.............................................#
#................................................#
#..@.............................................#
#................................................#
#..................T.............................#
#................................................#
#................................................#
#.............########........####################
#.............#......#........#..................#
#.............#......#........#..................#
#.............#......#........#..................#
#.............########........####################
#................................................#
#................................................#
#................................................#
#................................................#
#.........########..................##############
#.........#......#..................#............#
#.........#......#..................#............#
#.化.......#......#.........语........#............#
#.........#......#..................#............#
####......########..................##############
#................................................#
#................................................#
#..谚.......................................量.....#
#................................................#
#.....助..........................................#
#.........................................>......#
##################################################
"""

# Floor 3: Advanced Mastery and HSK 6 Examination
FLOOR_3_LAYOUT = """
##################################################
#..<.............................................#
#.@..............................................#
#................................................#
#................................................#
#................................................#
#..................T.............................#
#................................................#
#................................................#
#................汉...............................#
#................................................#
#................................................#
#................智...............................#
#................................................#
#.................................考..............#
#................................................#
#................................................#
#.................................书..............#
#................................................#
##################################################
"""


# Parse level strings into structured data
def parse_level(level_str: str, floor: int) -> dict:
    """Parse a level string into position data.

    Args:
        level_str: Multi-line string representing the level layout
        floor: Floor number (used for reference)

    Returns:
        Dictionary containing:
            - tiles: 2D list of characters
            - player_start: (x, y) tuple or None
            - stairs_down: (x, y) tuple or None
            - stairs_up: (x, y) tuple or None
            - npc_positions: dict of {char: [(x, y), ...]}
            - terminal_positions: list of (x, y) tuples
    """
    lines = list(level_str.strip().split("\n"))
    width = max(len(line) for line in lines) if lines else 0

    # Normalize line lengths
    lines = [line.ljust(width) for line in lines]

    tiles = []
    player_start = None
    npc_positions: dict[str, list[tuple[int, int]]] = {}
    terminal_positions = []
    stairs_up = []
    stairs_down = []

    for y, line in enumerate(lines):
        row = []
        for x, char in enumerate(line):
            if char == "@":
                player_start = (x, y)
                row.append(".")
            elif char == "T":
                terminal_positions.append((x, y))
                row.append(".")
            elif char == "<":
                stairs_up.append((x, y))
                row.append(".")
            elif char == ">":
                stairs_down.append((x, y))
                row.append(".")
            elif char == "#":
                row.append("#")
            elif char == "." or char == " ":
                row.append(".")
            else:
                # It's an NPC character (including Chinese characters)
                if char not in npc_positions:
                    npc_positions[char] = []
                npc_positions[char].append((x, y))
                row.append(".")
        tiles.append(row)

    return {
        "tiles": tiles,
        "player_start": player_start,
        "npc_positions": npc_positions,
        "terminal_positions": terminal_positions,
        "stairs_up": stairs_up,
        "stairs_down": stairs_down,
    }


# Create parsed levels dictionary
PARSED_LEVELS = {
    1: parse_level(FLOOR_1_LAYOUT, 1),
    2: parse_level(FLOOR_2_LAYOUT, 2),
    3: parse_level(FLOOR_3_LAYOUT, 3),
}

# Terminal content mapping for each zone/floor
ZONE_TERMINALS = {
    1: {
        "词汇基础区域": {
            "title": "HSK 6 词汇与成语基础",
            "content": [
                "欢迎来到HSK 6词汇学习系统！",
                "",
                "这里是词汇与成语基础区域。HSK 6级要求掌握",
                "5000个以上的词汇，以及大量成语。",
                "",
                "通过与词汇和成语专家的对话，证明你的",
                "掌握能力，向更高层次进发。",
            ],
        },
        "词汇殿堂": {
            "title": "词汇殿堂",
            "content": [
                "你已进入词汇殿堂。",
                "",
                "在这里，你将遇到精通各类词汇的导师：",
                "从基础词汇到高级表达。",
                "",
                "每位导师都掌握独特的词汇知识。",
                "证明自己，获得他们的认可。",
            ],
        },
    },
    2: {
        "成语文化区": {
            "title": "文化、语法与量词",
            "content": [
                "第二层：文化、语法与量词",
                "",
                "你已进入综合知识区。",
                "文化是语言的根基，语法是语言的骨架，",
                "量词是汉语的特色。",
                "",
                "掌握这些不仅是语言能力的体现，",
                "更是对中国文化的深入理解。",
            ],
        },
        "综合知识中心": {
            "title": "综合知识中心",
            "content": [
                "综合知识汇聚之地",
                "",
                "将词汇、成语、文化、语法、量词",
                "综合运用才是真正的掌握。",
                "",
                "掌握这些知识，方能真正精通中文。",
            ],
        },
    },
    3: {
        "HSK": {
            "title": "HSK 6级考试",
            "content": [
                "最终考试：HSK 6级认证",
                "",
                "你站在最后的考验面前。",
                "HSK 6考官将全面测试你的汉语水平。",
                "",
                "通过这里，即证明你的汉语已达到高级水平。",
                "智者与书法大师也在此等待有缘人。",
            ],
        },
        "高级挑战": {
            "title": "高级挑战",
            "content": [
                "最终挑战层",
                "",
                "这一层将测试你对所有知识点的",
                "综合掌握能力。",
                "",
                "只有真正精通的学习者",
                "才能通过这里的考验。",
            ],
        },
    },
}

# Boss NPCs - these get more questions
BOSS_NPCS = {
    "HSK_EXAMINER",
}
